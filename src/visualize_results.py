import os
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# ==========================
# 0. Basic settings
# ==========================
# Input ranking file generated by analysis.py
output_dir = "output"
ranking_path = os.path.join(output_dir, "movie_pca_ranking.csv")

if not os.path.exists(ranking_path):
    raise FileNotFoundError(
        f"Ranking file not found: {ranking_path}. "
        "Run analysis.py first to generate it."
    )

# ==========================
# 1. Load ranked data
# ==========================
df_ranked = pd.read_csv(ranking_path)

# In this script we just call it df for convenience
df = df_ranked.copy()

# Sanity check: required columns
required_cols = ["rating", "log_revenue", "popularity", "performance_index"]
missing = [c for c in required_cols if c not in df.columns]
if missing:
    raise ValueError(f"Missing required columns in ranking CSV: {missing}")

# ==========================
# 2. Correlation matrix & heatmap
# ==========================
corr_cols = ["rating", "log_revenue", "popularity", "performance_index"]
corr = df[corr_cols].corr(method="pearson")
print("\nCorrelation matrix:")
print(corr)

fig, ax = plt.subplots(figsize=(6, 5))
im = ax.imshow(corr.values, cmap="coolwarm", vmin=-1, vmax=1)

ax.set_xticks(np.arange(len(corr_cols)))
ax.set_yticks(np.arange(len(corr_cols)))
ax.set_xticklabels(corr_cols, rotation=45, ha="right")
ax.set_yticklabels(corr_cols)

# Add correlation values inside each cell
for i in range(len(corr_cols)):
    for j in range(len(corr_cols)):
        ax.text(j, i, f"{corr.values[i, j]:.2f}",
                ha="center", va="center", color="black", fontsize=8)

fig.colorbar(im, ax=ax, label="Correlation")
plt.title("Correlation Heatmap")
plt.tight_layout()

heatmap_path = os.path.join(output_dir, "correlation_heatmap.png")
fig.savefig(heatmap_path, dpi=300, bbox_inches="tight")
plt.close(fig)
print(f"[Saved] Correlation heatmap -> {heatmap_path}")

# ==========================
# 3. Scatter plot: log_revenue vs popularity, colored by rating
# ==========================
fig2, ax2 = plt.subplots(figsize=(6, 5))
sc = ax2.scatter(df["log_revenue"], df["popularity"],
                 c=df["rating"], alpha=0.7)
ax2.set_xlabel("log10(Box Office Revenue)")
ax2.set_ylabel("TMDb Popularity")
ax2.set_title("Movies colored by IMDb Rating")
cbar = fig2.colorbar(sc, ax=ax2)
cbar.set_label("Rating")
plt.tight_layout()

scatter_path = os.path.join(output_dir, "logrev_pop_rating_scatter.png")
fig2.savefig(scatter_path, dpi=300, bbox_inches="tight")
plt.close(fig2)
print(f"[Saved] Scatter plot -> {scatter_path}")
